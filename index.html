<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon"
    href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAgCAYAAAASYli2AAAAAXNSR0IArs4c6QAABCBJREFUSEudln9MVWUYxz/ve849F/ViKU4FScFfxSJa061WalHLlZnWAumPljb/aWW5llsuoI4yAptrbdVW/d0fCkhGm2VrQydra2kbOskkIEAxGyTJz3vPec/bzrlwu0Dpvb5/nvc8n/d5v8/zfPcKUll9tUvx9Ec4qplRp5G79/X8X5hIhUffwWUIdQrNEjza8FQTMbeRwUtnWfu5k8xIB3gSWJYI1rofpZtR6jBjIycoqBnw99IHav034CJEVgDXxPC8VpRuwIkdSx+I18SwqsGSz2LKLUixGpAB3PU648DzdoRIeCE//tzNtno1Q9e4hpNXbiD7rdLgn3Y7F9PcjGVWIkUOnh4RdOy/h3CoGkER4+pNVlQcuSlwcf7ziG3xg4+9FqYo53sMuQ5PDwl6a45jyo3BpvIuMOaUsOqd81Og0zNMBrbumUNW1rf/Ai/XXkOK2xMA1/uKq4PbWXvAFz++0gReR4rMpIw04+5+8sv3BTW8ZaDy/D7SGHIBfmuMOjtYWXk0DqxdCuIUgqVofYTs5WUJDZOvrLxhwaWaIQwZQXktRNWXzAq9hyCM67Ux5pawuvIXuuwMDOtTQsb2ANhypizRDXHgcQz5EDOAPX9uJXdBNSHz5SAzRzXSF3uJB+zrXKjKJ2IeRYpOWs6UpArcyPzb5hEJ12PIB9F4xNS75L1dHcjRUbWJkLGFjtguim03OPSGGQ4MPMG9B0fo3L+eDOswQmSj9SDj7ossr/iaZttkEXdxlQvpAf2Tf696Fcv6AIGF8s4xFC2hwL44o+lTytCParYzWGF9TMjYGZ9TVU/34E7WvT80BZoy0I86V34H8yK+nvcHekbdCvLLa24dGBhA1SPMDh1CikV4+i/G3V2caa1LrcqTRZkuVFfVbsLWQQQmWg/heIeIxT5kld3GaXs2i8Pf/XcfJgM1ghO2EVTzhzdmkZNVgWW+gpiYe0934ahPGB1tYG7ki8AcJhr7OobMDCYlGXj6sxDz+8uIDn8T2HtdqcGaomKs0F4MUYwITNXDVacRIhdD+n44LLhcGzeH6UBdZ3Cl8xAx9St55ZUJozi7dx6ZmTuwjNeRIm+KOsq7fANgqcGVNfXARkadFxJGMUloswuJWHswZSlCzEbrKFH3wM2A/rQ8h9I/MTK+iTvt/ikZ1dkWa8ynCZtP4bgnGXDrpwLbo49TbI8HQTrIMA6EHrSxgZw93TMmZdoHHziMFHPw9B9E3WrGnKbEy6CvtmEC2I02Hk4N2FvTjilXThyk8fRvKN1EzPG9cS9SbgbSAF6sKiBDPIk0SpHyvsBcgyvra4CBEHPTA05qELRDZAOmUYYUjyHFwiR50shwusq+5y2hkLDlvwy2IkQhgj60sT41DW9UtlY7l0zzGULGo0i1myUVvTer8j/XVnLemtRJOAAAAABJRU5ErkJggg=="
    type="image/x-icon">
  <title>批量铸造</title>
  <style>
    .title {
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      margin-top: 20px;
    }

    .tips {
      background: #b1b0b0;
      border: 1px solid #1af947;
      border-radius: 10px;
      color: rgb(35, 102, 161);
      font-size: 14px;
      padding: 10px;
    }

    .tips>div {
      margin-top: 5px;
    }


    .label {
      width: 100px;
      font-size: 16px;
      font-weight: bold;
    }

    .parse {
      background: #1900ff;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      margin-left: 10px;
    }

    .mint {
      margin-top: 20px;
      border: 1px solid #ff0088;
      padding: 10px;
      border-radius: 10px;
      color: #ffffff;
      background: #6fcf97;
    }

    .comfirn {
      background: #1873f4;
      color: #fff;
      padding: 5px 10px;
      border-radius: 5px;
      /* margin-left: 10px; */
      margin-top: 0px;
      text-align: center;
      font-weight: bold;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .content {
      background: #fff;
      padding: 20px 40px;
      border-radius: 10px;
    }
  </style>
</head>

<body>
  <!-- <div class="comfirn" onclick="test()">提交</div> -->

  <div id="app">
    <div class="title">NSC-20 铭文批量铸造</div>
    <div class="tips">
      <div style="font-weight: bold;margin-top: 0;">【重要提示】</div>
      <div>本脚本用于批量铸造NSC-20铭文。请注意：</div>
      <div><span style="color: #ef3f09;">1.</span> 使用前需手动拷贝您的私钥。本脚本不会连接网络，以保证安全性。</div>
      <div><span style="color: #ef3f09;">2.</span> 私钥安全由用户自行负责。若私钥泄露，与本脚本无关。</div>
      <div><span style="color: #ef3f09;">3.</span> 铸造操作一旦执行将无法撤销，请在操作前仔细确认。</div>
      <div>确保您充分理解这些指示和相关风险后再继续操作。</div>
    </div>

    <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 20px;">
      <div class="label" style="white-space: nowrap;">铸造参数</div>
      <div style="display: flex; align-items: center; margin-left: 20px; flex-grow: 1;">
        <input placeholder="粘贴铭文数据自动识别需要铸造的铭文" type="text" style="flex-grow: 1; margin-right: 10px;"
          v-model="mintText" />
        <div class="parse" style="white-space: nowrap;" @click="identify">识别</div>
      </div>
    </div>

    <div class="mint">
      <div style="display: flex;justify-content: space-between;">
        <div>协议</div>
        <div>nsc-20</div>
      </div>
      <div style="display: flex;justify-content: space-between;margin-top: 10px;">
        <div>操作</div>
        <div>mint</div>
      </div>
      <div style="display: flex;justify-content: space-between;margin-top: 10px;">
        <div>名称</div>
        <input placeholder="不区分大小写,4个字母左右" type="text" style="width: 200px; text-align: right" v-model="mintName" />
      </div>
      <div style="color:red;font-weight: bold;display: flex;justify-content: space-between;margin-top: 10px;">
        <div>单次铸造数量</div>
        <input placeholder="整数,和你打的铭文数量保持一致" type="number"
          style="width: 200px;text-align: right;color:rgb(182, 16, 16);font-weight: bold;" v-model="mintNum" />
      </div>

      <div style="display: flex;justify-content: space-between;margin-top: 10px;">
        <div>铸造次数,推荐10</div>
        <input placeholder="整数,注意不要超过铸造上限" type="number" style="width: 200px;text-align: right;" v-model="count" />
      </div>
      <div style="display: flex;justify-content: space-between;margin-top: 10px;">
        <div>并发数量,推荐3</div>
        <input placeholder="同一时间发送,数量越大失败越高" type="number" style="width: 200px;text-align: right;" v-model="syncNum" />
      </div>
      <div style="display: flex;justify-content: space-between;margin-top: 10px;">
        <div style="font-size: 13px;">
          <div>gas费,最少22000</div>
          <div>22000==1.8nuls</div>
        </div>
        <input placeholder="gas费越高成功率越高" type="number" style="width: 200px;text-align: right;" v-model="gas" />
      </div>

      <div
        style="overflow: scroll; max-height: 100px;margin-top:10px;padding:5px;border:3px solid #ffee00;border-radius: 10px;"
        v-if="count&&mintTextComp">
        <div style="font-size: 10px;margin-top: 10px;white-space: nowrap;" v-for="item in countComp" :key="item">
          {{item}} ==> {{mintTextComp}}</div>
      </div>


    </div>

    <div style="display: flex;padding:10px;padding-bottom: 5px;">
      <input placeholder="**私钥**" type="password" style="flex-grow: 1; margin-right: 10px;" v-model="privateKey" />
    </div>

    <div class="comfirn" @click="modal=true,msg='确定铸造？',confirm='我确定'">提交</div>




    <div class="modal" style="color: #fff;font-weight: bold;font-size: 24px;" v-if="loading">
      铸造中...
    </div>

    <div class="modal" style="font-weight: bold;font-size: 24px;flex-direction: column;" v-if="paddingShow">
      <div class="content" style="text-align: center;width: 15rem;max-height: 400px;overflow: auto;">
        <div style="font-size: 10px;">
          不要关闭此页面,也不要后台.否则可能不会执行,如果没反应,停止重新执行
        </div>
        <div style="margin-top: 20px;">总数: {{count}}</div>
        <div style="margin-top: 20px;">成功: {{done}}</div>
      </div>
      <div class="comfirn" style="background: #ff0088;" @click="stopProcess">停止</div>
    </div>


    <div class="modal" v-if="modal" @click="modal=false">
      <div class="content" @click.stop>
        <div style="font-weight: bold;font-size: 24px;">提示!</div>
        <div style="margin: 15px 0;">{{msg}}</div>
        <div class="comfirn" style="background: #ff0088;" @click="mint">{{confirm}}</div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
  <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>


  <script>

    function base64ToArrayBuffer(base64) {
      var binaryString = window.atob(base64);
      var len = binaryString.length;
      var bytes = new Uint8Array(len);
      for (var i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes.buffer;
    }

    async function decrypt(base64Str, password) {
      const dec = new TextDecoder();
      const enc = new TextEncoder();
      const combinedArrayBuffer = base64ToArrayBuffer(base64Str);

      const salt = new Uint8Array(combinedArrayBuffer.slice(0, 16));
      const iv = new Uint8Array(combinedArrayBuffer.slice(16, 32));
      const encryptedStart = 32;
      const authTagStart = combinedArrayBuffer.byteLength - 16;
      const encrypted = new Uint8Array(combinedArrayBuffer.slice(encryptedStart, authTagStart));
      const authTag = new Uint8Array(combinedArrayBuffer.slice(authTagStart));

      const keyMaterial = await crypto.subtle.importKey(
        "raw",
        enc.encode(password),
        "PBKDF2",
        false,
        ["deriveKey"]
      );

      const key = await crypto.subtle.deriveKey(
        {
          "name": "PBKDF2",
          salt: salt,
          "iterations": 10000,
          "hash": "SHA-512"
        },
        keyMaterial,
        { "name": "AES-GCM", "length": 256 },
        false,
        ["decrypt"]
      );

      try {
        const decrypted = await crypto.subtle.decrypt(
          {
            name: "AES-GCM",
            iv: iv,
            additionalData: new Uint8Array(), // 确保与加密时的设置一致
            tagLength: 128
          },
          key,
          new Uint8Array([...encrypted, ...authTag])
        );

        return dec.decode(decrypted);
      } catch (e) {
        console.error(e);
        return null;
      }
    }



  </script>

  <script>
    new Vue({
      el: '#app',
      components: {},
      data: {
        loading: false,
        modal: false,
        paddingShow: false,
        billingShow: false,
        privateKey: '',
        mintText: '',
        mintName: '',
        mintNum: 1,
        count: 100,
        syncNum: 3,
        gas: 23500,

        msg: "确定铸造？",
        confirm: "好的",
        transactionList: [],

        lock: false,
        done: 0,
        timer: null,
      },
      mounted() {
      },
      computed: {
        mintTextComp() {
          return 'data:,{"p":"nsc-20","op":"mint","amt":"' + this.mintNum + '","tick":"' + this.mintName + '","plat":"luck"}'
        },
        countComp() {
          return Number(this.count)
        }
      },
      methods: {
        async mint() {
          this.modal = false
          if (this.confirm == "好的") {
          } else {
            this.submit()
          }
        },
        identify() {
          if (this.mintText == '') {
            this.message("请输入铭文数据")
            return
          }

          let str = this.mintText.replace('data:,', '')

          if (isValidJSON(str)) {
            const data = JSON.parse(str)
            this.validate(data);
            return
          }

          try {
            const hexString = str;
            const convertedString = ethers.utils.toUtf8String(hexString);
            str = convertedString.replace('data:,', '')
            if (isValidJSON(str)) {
              const data = JSON.parse(str)
              this.validate(data);
              return
            } else {
              this.message("无法识别铭文数据")
            }
          } catch (e) {
            console.log(e);
            this.message("无法识别铭文数据")
            this.modal = true
          }


        },
        // 验证
        validate(obj) {
          console.log(1, obj.p != 'nsc-20');
          console.log(2, obj.op != 'mint');
          console.log(3, !!obj.amt);
          console.log(4, !!obj.tick);
          console.log(5, obj.plat != 'luck');

          if (obj.p != 'nsc-20' || obj.op != 'mint' || !obj.amt || !obj.tick || obj.plat != 'luck') {
            this.message("输入铭文数据不正确")
            return
          }
          this.mintName = obj.tick
          this.mintNum = obj.amt
          // this.count = 1
        },
        message(msg) {
          this.msg = msg
          this.confirm = "好的"
          this.modal = true
          this.loading = false
        },
        async submit() {
          if (this.mintName == "") {
            this.message("请输入铸造名称")
            return
          }

          if (Number(this.mintNum) == 0 || this.mintNum == "") {
            this.message("单次铸造数量不正确")
            return
          }
          if (Number(this.count) == 0 || this.count == "") {
            this.message("铸造次数不能少于一次")
            return
          }

          if (this.privateKey == "") {
            this.message("请输入私钥")
            return
          }

          this.loading = true
          let wallet
          try {
            wallet = new ethers.Wallet(this.privateKey);
          } catch (e) {
            this.message("私钥不正确")
            return
          }

          // const provider = new ethers.providers.JsonRpcProvider("https://rpc.ankr.com/bsc");
          // const contract = new ethers.Contract("0xe80480860143309F3A4b0b559F35f0391080472B", [
          //   {
          //     "inputs": [],
          //     "name": "claimBalance",
          //     "outputs": [],
          //     "stateMutability": "nonpayable",
          //     "type": "function"
          //   },
          //   {
          //     "inputs": [
          //       {
          //         "internalType": "address",
          //         "name": "_token",
          //         "type": "address"
          //       },
          //       {
          //         "internalType": "uint256",
          //         "name": "amount",
          //         "type": "uint256"
          //       }
          //     ],
          //     "name": "claimToken",
          //     "outputs": [],
          //     "stateMutability": "nonpayable",
          //     "type": "function"
          //   },
          //   {
          //     "inputs": [
          //       {
          //         "internalType": "address",
          //         "name": "newOwner",
          //         "type": "address"
          //       }
          //     ],
          //     "name": "transferOwnership",
          //     "outputs": [],
          //     "stateMutability": "nonpayable",
          //     "type": "function"
          //   },
          //   {
          //     "stateMutability": "payable",
          //     "type": "receive"
          //   },
          //   {
          //     "inputs": [],
          //     "name": "AMOUNT_THRESHOLD",
          //     "outputs": [
          //       {
          //         "internalType": "uint256",
          //         "name": "",
          //         "type": "uint256"
          //       }
          //     ],
          //     "stateMutability": "view",
          //     "type": "function"
          //   },
          //   {
          //     "inputs": [
          //       {
          //         "internalType": "address",
          //         "name": "",
          //         "type": "address"
          //       }
          //     ],
          //     "name": "billing",
          //     "outputs": [
          //       {
          //         "internalType": "bool",
          //         "name": "",
          //         "type": "bool"
          //       }
          //     ],
          //     "stateMutability": "view",
          //     "type": "function"
          //   },
          //   {
          //     "inputs": [],
          //     "name": "owner",
          //     "outputs": [
          //       {
          //         "internalType": "address",
          //         "name": "",
          //         "type": "address"
          //       }
          //     ],
          //     "stateMutability": "view",
          //     "type": "function"
          //   }
          // ], provider);

          // try {
          //   let flag = await contract.billing(wallet.address)
          //   if (!flag) {
          //     // 弹出收费提示
          //     this.billingShow = true
          //     this.loading = false
          //     return
          //   }
          // } catch (e) {
          //   this.message("未知错误")
          //   return
          // }
          this.process(this)
        },

        async process() {
          // const privateKey = ethers.Wallet.createRandom().privateKey;
          // console.log(privateKey);
          // return
          this.loading = true
          let jsonData = {
            "p": "nsc-20",
            "op": "mint",
            "amt": this.mintNum.toString(),
            "tick": this.mintName.toString(),
            "plat": "luck"
          }

          let jsonString = 'data:,' + JSON.stringify(jsonData);
          const hexString = ethers.utils.hexlify(ethers.utils.toUtf8Bytes(jsonString));
          const provider = new ethers.providers.JsonRpcProvider("https://evmapi.nuls.io");
          const wallet = new ethers.Wallet(this.privateKey, provider);

          clearInterval(this.timer)
          this.done = 0
          this.paddingShow = true
          this.loading = false
          this.lock = false

          this.timer = setInterval(async () => {
            if (this.lock) {
              return
            }

            if (this.done >= this.count) {
              clearInterval(this.timer)
              return
            }


            this.lock = true

            let nonce = await wallet.provider.getTransactionCount(wallet.address)
            const transaction = {
              to: wallet.address,
              value: ethers.utils.parseEther(String('0')),
              data: hexString,
              nonce: nonce,
              gasLimit: ethers.utils.hexlify(parseInt(this.gas)),
              gasPrice: await provider.getGasPrice()
            };

            let innerNum = 0
            for (let index = 0; index < this.syncNum; index++) {
              transaction.nonce += index
              try {
                const sendResult = wallet.sendTransaction(transaction);
                sendResult.then(resp => {
                  resp.wait().then(res => {
                    console.log("success", res);
                    this.done++
                    innerNum++
                    if (innerNum >= this.syncNum) {
                      this.lock = false
                    }
                  }).catch(err => {
                    console.log(111, err);
                    innerNum++
                    if (innerNum >= this.syncNum) {
                      this.lock = false
                    }
                  })
                }).catch(err => {
                  console.log(222, err);
                  innerNum++
                  if (innerNum >= this.syncNum) {
                    this.lock = false
                  }
                })
              } catch (e) {
                console.log(333, e);
                innerNum++
                if (innerNum >= this.syncNum) {
                  this.lock = false
                }
              }
            }
          }, 3000);
        },

        stopProcess() {
          this.paddingShow = false
          this.loading = false
          this.lock = false
          clearInterval(this.timer)
        },

        copy(t) {
          var e = t; //要复制的内容
          (e = "string" === typeof e ? e : e.toString()),
            document.queryCommandSupported("copy") || alert("复制失败,设备不支持~");
          var r = document.createElement("textarea");
          (r.value = e),
            // @ts-ignore
            (r.readOnly = "readOnly"),
            document.body.appendChild(r),
            r.select(),
            r.setSelectionRange(0, e.length);
          document.execCommand("copy");
          r.remove(), this.message("复制成功");
        },
      }
    })

    const isValidJSON = (jsonString) => {
      try {
        JSON.parse(jsonString);
        return true;
      } catch (e) {
        return false;
      }
    }


    // async function main() {
    //   const decrypt = async (base64Str, password) => {
    //     const dec = new TextDecoder();
    //     const enc = new TextEncoder();
    //     const combinedArrayBuffer = base64ToArrayBuffer(base64Str);

    //     const salt = new Uint8Array(combinedArrayBuffer.slice(0, 16));
    //     const iv = new Uint8Array(combinedArrayBuffer.slice(16, 32));
    //     const encryptedStart = 32;
    //     const authTagStart = combinedArrayBuffer.byteLength - 16;
    //     const encrypted = new Uint8Array(combinedArrayBuffer.slice(encryptedStart, authTagStart));
    //     const authTag = new Uint8Array(combinedArrayBuffer.slice(authTagStart));

    //     const keyMaterial = await crypto.subtle.importKey(
    //       "raw",
    //       enc.encode(password),
    //       "PBKDF2",
    //       false,
    //       ["deriveKey"]
    //     );

    //     const key = await crypto.subtle.deriveKey(
    //       {
    //         "name": "PBKDF2",
    //         salt: salt,
    //         "iterations": 10000,
    //         "hash": "SHA-512"
    //       },
    //       keyMaterial,
    //       { "name": "AES-GCM", "length": 256 },
    //       false,
    //       ["decrypt"]
    //     );

    //     try {
    //       const decrypted = await crypto.subtle.decrypt(
    //         {
    //           name: "AES-GCM",
    //           iv: iv,
    //           additionalData: new Uint8Array(), // 确保与加密时的设置一致
    //           tagLength: 128
    //         },
    //         key,
    //         new Uint8Array([...encrypted, ...authTag])
    //       );

    //       return dec.decode(decrypted);
    //     } catch (e) {
    //       console.error(e);
    //       return null;
    //     }
    //   }
    //   let submitFuncStr = await decrypt(submitBase64Str, 'nimasile')
    //   submit = new AsyncFunction('_this', submitFuncStr);
    //   let processFuncStr = await decrypt(processBase64Str, 'nibasile')
    //   process = new AsyncFunction('_this', processFuncStr);
    //   myVue.$data.loading = false
    //   myVue.$data.loadingMsg = "铸造中..."
    // }
    // main()


  </script>


</body>

</html>
